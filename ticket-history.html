<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ExeTickets - Ticket History</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#c7342a" />
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #c7342a;
      --secondary: #63d0e8;
      --background: #f0f4f8;
      --card-bg: white;
      --text: #333;
      --border: #ccc;
      --shadow: rgba(0,0,0,0.1);
      --glass-bg: rgba(255,255,255,0.2);
      --accent: #007bff;
    }

    [data-theme="dark"] {
      --primary: #e74c3c;
      --secondary: #3498db;
      --background: #121212;
      --card-bg: #1e1e1e;
      --text: #f0f0f0;
      --border: #444;
      --shadow: rgba(0,0,0,0.3);
      --glass-bg: rgba(255,255,255,0.1);
      --accent: #4CAF50;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text);
      padding: 20px;
      padding-bottom: 80px;
      transition: all 0.3s ease;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .back-btn {
      background: var(--glass-bg);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 15px;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    h1 {
      color: var(--primary);
      font-size: 24px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
    }

    .filter-tab {
      padding: 10px 20px;
      background: var(--glass-bg);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
      white-space: nowrap;
    }

    .filter-tab.active {
      background: var(--primary);
      color: white;
    }

    .filter-tab:hover {
      transform: translateY(-2px);
    }

    .tickets-container {
      display: grid;
      gap: 15px;
    }

    .ticket-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px var(--shadow);
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary);
      cursor: pointer;
    }

    .ticket-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow);
    }

    .ticket-card.invalid {
      border-left-color: #ff4d4d;
      opacity: 0.7;
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .ticket-route {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
    }

    .ticket-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .ticket-status.valid {
      background: #4CAF50;
      color: white;
    }

    .ticket-status.invalid {
      background: #ff4d4d;
      color: white;
    }

    .ticket-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
    }

    .detail-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .detail-value {
      font-size: 14px;
      font-weight: 500;
    }

    .ticket-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .ticket-time {
      font-size: 12px;
      color: #666;
    }

    .ticket-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      background: var(--glass-bg);
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      color: var(--text);
    }

    .action-btn:hover {
      background: var(--primary);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      color: var(--border);
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      box-shadow: 0 -2px 10px var(--shadow);
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 8px;
    }

    .nav-item:hover {
      background: var(--glass-bg);
      transform: translateY(-2px);
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item i {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .nav-item span {
      font-size: 12px;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4d4d;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .ticket-details {
        grid-template-columns: 1fr;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon" id="theme-icon"></i>
  </button>

  <div class="header">
    <button class="back-btn" onclick="window.history.back()">
      <i class="fas fa-arrow-left"></i>
    </button>
    <h1>My Tickets</h1>
  </div>

  <div class="stats-container" id="stats-container">
    <div class="stat-card">
      <div class="stat-value" id="total-tickets">0</div>
      <div class="stat-label">Total Tickets</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="valid-tickets">0</div>
      <div class="stat-label">Valid Tickets</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="total-spent">₹0</div>
      <div class="stat-label">Total Spent</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="saved-amount">₹0</div>
      <div class="stat-label">Amount Saved</div>
    </div>
  </div>

  <div class="filter-tabs">
    <button class="filter-tab active" onclick="filterTickets('all')">All</button>
    <button class="filter-tab" onclick="filterTickets('valid')">Valid</button>
    <button class="filter-tab" onclick="filterTickets('invalid')">Invalid</button>
    <button class="filter-tab" onclick="filterTickets('pending')">Pending</button>
  </div>

  <div class="tickets-container" id="tickets-container">
    <div class="empty-state">
      <i class="fas fa-ticket-alt"></i>
      <h3>No tickets found</h3>
      <p>Book your first ticket to get started!</p>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="index.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="ticket-history.html" class="nav-item active">
      <i class="fas fa-history"></i>
      <span>History</span>
      <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
    </a>
    <a href="profile.html" class="nav-item" target="_blank">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </div>

  <script>
    let currentFilter = 'all';
    let tickets = [];

    // Initialize app
    function initApp() {
      loadTheme();
      loadTickets();
      updateStats();
      updateNotificationBadge();
      checkTicketExpiry();
    }

    // Theme management
    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeIcon(theme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
    }

    // Load tickets
    function loadTickets() {
      tickets = JSON.parse(localStorage.getItem("tickets") || "[]");
      const myKey = localStorage.getItem('secretKey');
      
      // Filter tickets owned by me
      tickets = tickets.filter(ticket => ticket.owner === myKey);
      
      renderTickets();
    }

    // Render tickets
    function renderTickets() {
      const container = document.getElementById('tickets-container');
      let filteredTickets = tickets;

      // Apply filter
      if (currentFilter === 'valid') {
        filteredTickets = tickets.filter(t => t.status === 'VALID');
      } else if (currentFilter === 'invalid') {
        filteredTickets = tickets.filter(t => t.status === 'INVALID');
      } else if (currentFilter === 'pending') {
        filteredTickets = tickets.filter(t => t.pending);
      }

      if (filteredTickets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-ticket-alt"></i>
            <h3>No tickets found</h3>
            <p>${currentFilter === 'all' ? 'Book your first ticket to get started!' : `No ${currentFilter} tickets found.`}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredTickets.map(ticket => `
        <div class="ticket-card ${ticket.status.toLowerCase()}" onclick="viewTicket('${ticket.id}')">
          <div class="ticket-header">
            <div class="ticket-route">${ticket.routeName}</div>
            <div class="ticket-status ${ticket.status.toLowerCase()}">${ticket.status}</div>
          </div>
          
          <div class="ticket-details">
            <div class="detail-item">
              <div class="detail-label">Route</div>
              <div class="detail-value">${ticket.route}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Bus Number</div>
              <div class="detail-value">${ticket.number}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Fare</div>
              <div class="detail-value">₹${ticket.fare}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Bus Color</div>
              <div class="detail-value">${ticket.color}</div>
            </div>
          </div>
          
          <div class="ticket-footer">
            <div class="ticket-time">${new Date(ticket.time).toLocaleString()}</div>
            <div class="ticket-actions">
              <button class="action-btn" onclick="event.stopPropagation(); rebookTicket('${ticket.id}')">
                <i class="fas fa-redo"></i> Rebook
              </button>
              <button class="action-btn" onclick="event.stopPropagation(); deleteTicket('${ticket.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Filter tickets
    function filterTickets(filter) {
      currentFilter = filter;
      
      // Update active tab
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      renderTickets();
    }

    // Update statistics
    function updateStats() {
      const totalTickets = tickets.length;
      const validTickets = tickets.filter(t => t.status === 'VALID').length;
      const totalSpent = tickets.reduce((sum, t) => sum + parseFloat(t.fare), 0);
      const totalOriginal = tickets.reduce((sum, t) => sum + t.price, 0);
      const savedAmount = totalOriginal - totalSpent;

      document.getElementById('total-tickets').textContent = totalTickets;
      document.getElementById('valid-tickets').textContent = validTickets;
      document.getElementById('total-spent').textContent = `₹${totalSpent.toFixed(1)}`;
      document.getElementById('saved-amount').textContent = `₹${savedAmount.toFixed(1)}`;
    }

    // View ticket
    function viewTicket(ticketId) {
      window.location.href = `ticket.html?id=${ticketId}`;
    }

    // Rebook ticket
    function rebookTicket(ticketId) {
      const ticket = tickets.find(t => t.id === ticketId);
      if (!ticket) return;

      // Store rebook data in localStorage
      localStorage.setItem('rebookData', JSON.stringify(ticket));
      
      // Navigate to home
      window.location.href = 'index.html';
    }

    // Delete ticket
    function deleteTicket(ticketId) {
      if (!confirm('Are you sure you want to delete this ticket?')) return;

      const index = tickets.findIndex(t => t.id === ticketId);
      if (index > -1) {
        tickets.splice(index, 1);
        localStorage.setItem('tickets', JSON.stringify(tickets));
        loadTickets();
        updateStats();
      }
    }

    // Update notification badge
    function updateNotificationBadge() {
      const allTickets = JSON.parse(localStorage.getItem("tickets") || "[]");
      const myKey = localStorage.getItem('secretKey');
      const pendingCount = allTickets.filter(t => t.owner === myKey && t.pending).length;
      
      const badge = document.getElementById('notification-badge');
      if (pendingCount > 0) {
        badge.textContent = pendingCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    // Check ticket expiry
    function checkTicketExpiry() {
      const now = new Date();
      let updated = false;

      tickets.forEach(ticket => {
        if (ticket.status === 'VALID') {
          const ticketTime = new Date(ticket.time);
          const minutesDiff = (now - ticketTime) / (1000 * 60);
          
          if (minutesDiff > 30) {
            ticket.status = 'INVALID';
            updated = true;
          }
        }
      });

      if (updated) {
        localStorage.setItem('tickets', JSON.stringify(tickets));
        renderTickets();
        updateStats();
      }
    }

    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);

    // Check ticket expiry every minute
    setInterval(checkTicketExpiry, 60000);
  </script>
</body>
</html>